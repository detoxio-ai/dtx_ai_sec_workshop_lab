#!/bin/bash

# Exit immediately on error
set -e

# Constants
SECRETS_DIR="$HOME/.secrets"
OPENAI_FILE="$SECRETS_DIR/OPEN_AI_KEY.txt"
VENV_DIR="$HOME/.pentestgpt-venv"
REPO_URL="https://github.com/GreyDGL/PentestGPT"
PACKAGE_URL="git+$REPO_URL"
REQUIREMENTS_CMD="pentestgpt-connection"
LAUNCH_CMD="pentestgpt"

# Check OpenAI key file
if [ ! -f "$OPENAI_FILE" ]; then
  echo "‚ùå ERROR: OpenAI API key not found at $OPENAI_FILE"
  echo "‚û°Ô∏è  Create the file and paste your key like this:"
  echo "   $ echo 'sk-...' > $OPENAI_FILE"
  exit 1
fi

# Read OpenAI key
OPENAI_KEY=$(cat "$OPENAI_FILE" | tr -d '\r\n')

# Create virtual environment
echo "üîß Creating Python virtual environment..."
python3 -m venv "$VENV_DIR"
source "$VENV_DIR/bin/activate"

# Upgrade pip and install package
echo "üì¶ Installing PentestGPT from $REPO_URL..."
pip install --upgrade pip
pip install "$PACKAGE_URL"

# Export key to environment
export OPENAI_API_KEY="$OPENAI_KEY"
echo "‚úÖ OpenAI API key loaded from $OPENAI_FILE"

# Test connection
echo "üîå Testing API connectivity..."
if command -v $REQUIREMENTS_CMD &>/dev/null; then
  $REQUIREMENTS_CMD || echo "‚ö†Ô∏è Connection test failed. Check your API key."
else
  echo "‚ùå ERROR: $REQUIREMENTS_CMD not found. Install may have failed."
fi

# Completion message
echo -e "\n‚úÖ PentestGPT installation complete."
echo "üìç To use PentestGPT later:"
echo "   source $VENV_DIR/bin/activate"
echo "   pentestgpt"
